{% extends 'layout.html' %}

{% block title %}Asignacion{% endblock %}

{% block body_class %}asignacion{% endblock %}

{% block css %}
<style>
  .btns {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0.5rem;
  }

  .btns .semestre {
    width: 100px;
    height: 30px;
    margin-left: 10px;
    border: none;
    margin-right: 10px;
    border-radius: 15px;
    transition: .5s;
  }

  .materia.selected {
    border: #32aa32 2px solid;
    background: #37109b;
  }

  .btns .semestre:hover {
    background-color: #37109b;
    color: white;
  }

  .btnsturn {
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: Montserrat;
  }

  .btnsturn .turno:hover {
    background-color: #37109b;
    border: none;
    color: white;
  }

  .btnsturn .turno {
    width: 100px;
    border: none;
    height: 30px;
    margin-left: 10px;
    margin-right: 10px;
    border-radius: 15px;
    transition: .5s;
  }

  .btnsturn .turno.selected {
    background-color: #37109b;
    color: white;
    border: #32aa32 2px solid;
  }

  .container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 0.5fr;
    gap: 0px 0px;
    grid-auto-flow: row;
    grid-template-areas:
      "docentes horario"
      "materias aulas";
    font-family: Montserrat;
  }

  .docentes {
    grid-area: docentes;
    height: 2rem;
    display: flex;
    text-align: center;
    flex-wrap: wrap;
  }

  .aula.selected {
    border: #32aa32 2px solid;
    background: #37109b;
    color: white;
  }

  .horario {
    grid-area: horario;
    height: 22rem;
    text-align: center;
  }

  .materias {
    grid-area: materias;
    height: 22rem;
    display: flex;
    align-content: flex-start;
    text-align: center;
    flex-wrap: wrap;
    gap: 1rem;
  }


  .aulas {
    grid-area: aulas;
    height: 22rem;
    gap: 1rem;
    display: flex;
    text-align: center;
    flex-wrap: wrap;
  }

  .docente.selected {
    border: #37109b 2px solid;
  }

  .btn {
    display: flex;
    align-items: center;
    justify-content: end;
  }

  .savebtn {
    width: 100px;
    height: 30px;
    margin-left: 10px;
    margin-right: 10px;
    border-radius: 15px;
    transition: .5s;
    position: fixed;
    bottom: 10px;
    right: 10px;
    z-index: 9999;
  }

  .semestre.selected {
    background-color: blue;
    border: #32aa32 2px solid;
    color: white;
  }

  .docente {
    color: black;
    height: 30px;
    background-color: #897baf;
    border-radius: 10px;
    color: white;
    margin: 5px;
    font-synthesis: none;
    padding: 0.3rem;
    font-family: Montserrat;
    font-style: initial;

  }

  .docente.selected {
    background: #37109b;
    color: white;
    border: #32aa32 2px solid;
  }

  .docente p {
    user-select: none;
    text-align: center;
    margin-top: 5px;
  }

  .materia {
    width: auto;
    height: 55px;
    background-color: #897baf;
    color: white;
    border-radius: 5px;
    margin-top: 10px;
    padding: 0.4rem;
  }

  .materia p {
    user-select: none;
    text-align: center;
    color: white;
    margin-top: 5px;
  }

  .aula {
    width: auto;
    height: 55px;
    background-color: #897baf;
    border-radius: 5px;
    color: white;
    margin-top: 5px;
    padding: 0.4rem;
  }

  .aula p {
    user-select: none;
    text-align: center;
    margin-top: 5px;
  }

  table {
    user-select: none;
    background-color: black;
    width: 50rem;
    height: 20rem;

  }

  table tr {
    background-color: white;
    border: none;
  }

  table td {
    border: 0px solid;
    border-radius: 1px;
  }

  table th {
    background-color: #ddd;
  }

  table td {
    max-width: 100px;
    /* Ajusta el valor según sea necesario */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 10px;
    /* Ajusta el tamaño de la letra según sea necesario */
  }

  .semestre.selected {
    background-color: #37109b;
    border: #32aa32 2px solid;

    color: white;
  }

  .selected {
    background-color: lightblue;
    /* Cambiar el color de fondo de los elementos seleccionados */
  }
</style>
{% endblock %}

{% block content %}
<div class="btns">
  <button class="semestre" data-semestre="1">Semestre 1</button>
  <button class="semestre" data-semestre="2">Semestre 2</button>
  <button class="semestre" data-semestre="3">Semestre 3</button>
  <button class="semestre" data-semestre="4">Semestre 4</button>
  <button class="semestre" data-semestre="5">Semestre 5</button>
  <button class="semestre" data-semestre="6">Semestre 6</button>
  <button class="semestre" data-semestre="7">Semestre 7</button>
  <button class="semestre" data-semestre="8">Semestre 8</button>
  <button class="semestre" data-semestre="9">Semestre 9</button>
</div>
<div class="btnsturn">
  <p>Grupos:</p>
  {% for grupo in grupos %}
  <button class="grupo turno" id="{{ grupo.id }}" data-semestre="{{ grupo.semestre }}"
    data-turno="{{ grupo.identificador }}" style="display: none;">{{ grupo.identificador }}</button>
  {% endfor %}
</div>

<div class="container">
  <div class="docentes">
    <p>Docentes</p>
    {% for docente in docentes %}
    <div class="docente" data-id-docente='{{docente.usuario.id}}' data-nombre="{{ docente.usuario.nombre }}"
      data-apellido="{{ docente.usuario.apellido_pat }}">
      <p><strong>{{docente.usuario.nombre}} {{docente.usuario.apellido_pat}} </strong></p>
    </div>
    {% endfor %}
  </div>

  <div class="horario">
    <table id="TablaHorario">
      <tr>
        <th>Horas</th>
        <th>Lunes</th>
        <th>Martes</th>
        <th>Miercoles</th>
        <th>Jueves</th>
        <th>Viernes</th>
        <th>Sábado</th>
      </tr>
      <tr>
        <td class="hora hora-1">7-8</td>
        <td class="dia" id="0"></td>
        <td class="dia" id="15"></td>
        <td class="dia" id="30"></td>
        <td class="dia" id="45"></td>
        <td class="dia" id="60"></td>
        <td class="dia" id="75"></td>
      </tr>
      <tr>
        <td class="hora hora-2">8-9</td>
        <td class="dia" id="1"></td>
        <td class="dia" id="16"></td>
        <td class="dia" id="31"></td>
        <td class="dia" id="46"></td>
        <td class="dia" id="61"></td>
        <td class="dia" id="76"></td>
      </tr>
      <tr>
        <td class="hora hora-3">9-10</td>
        <td class="dia" id="2"></td>
        <td class="dia" id="17"></td>
        <td class="dia" id="32"></td>
        <td class="dia" id="47"></td>
        <td class="dia" id="62"></td>
        <td class="dia" id="77"></td>
      </tr>
      <tr>
        <td class="hora hora-4">10-11</td>
        <td class="dia" id="3"></td>
        <td class="dia" id="18"></td>
        <td class="dia" id="33"></td>
        <td class="dia" id="48"></td>
        <td class="dia" id="63"></td>
        <td class="dia" id="78"></td>
      </tr>
      <tr>
        <td class="hora hora-5">11-12</td>
        <td class="dia" id="4"></td>
        <td class="dia" id="19"></td>
        <td class="dia" id="34"></td>
        <td class="dia" id="49"></td>
        <td class="dia" id="64"></td>
        <td class="dia" id="79"></td>
      </tr>
      <tr>
        <td class="hora hora-6">12-13</td>
        <td class="dia" id="5"></td>
        <td class="dia" id="20"></td>
        <td class="dia" id="35"></td>
        <td class="dia" id="50"></td>
        <td class="dia" id="65"></td>
        <td class="dia" id="80"></td>
      </tr>
      <tr>
        <td class="hora hora-7">13-14</td>
        <td class="dia" id="6"></td>
        <td class="dia" id="21"></td>
        <td class="dia" id="36"></td>
        <td class="dia" id="51"></td>
        <td class="dia" id="66"></td>
        <td class="dia" id="81"></td>
      </tr>
      <tr>
        <td class="hora hora-8">14-15</td>
        <td class="dia" id="7"></td>
        <td class="dia" id="22"></td>
        <td class="dia" id="37"></td>
        <td class="dia" id="52"></td>
        <td class="dia" id="67"></td>
        <td class="dia" id="82"></td>
      </tr>
    </table>
  </div>
  <div class="materias">
    <p>Materias</p>
    {% for asignatura in asignaturas %}
    <div class="materia" data-semestre="{{ asignatura.materia.semestre }}" data-id-materia='{{asignatura.materia.id}}'
      data-credito="{{asignatura.materia.creditos}}" data-nombre="{{ asignatura.materia.nombre }}">
      <p>{{ asignatura.materia.nombre }}</p>
      <p>Créditos: {{ asignatura.materia.creditos }}</p>
    </div>
    {% endfor %}
  </div>
  <div class="aulas">
    <p><strong>Aulas</strong></p>
    {% for aula in aulas %}
    <div class="aula" data-id-aula="{{aula.id}}" data-nombre="{{ aula.nombre }}">
      <p>{{ aula.nombre }}</p>
      <p>{{ aula.edificio }}</p>
    </div>
    {% endfor %}
  </div>
</div>
<div class="btn">
  <button class="savebtn"> guardar</button>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var diasOriginales = [];
    var horasOriginales = [];
    var celdasDia = document.querySelectorAll(".dia");
    var celdasHora = document.querySelectorAll(".hora");

    celdasDia.forEach(function (celdaDia) {
      diasOriginales.push(celdaDia.id);
    });

    celdasHora.forEach(function (celdaHora) {
      horasOriginales.push(celdaHora.textContent);
    });

    // Función para mostrar las materias del semestre seleccionado
    function mostrarMateriasPorSemestre(semestreSeleccionado) {
      // Obtener todas las materias
      var materias = document.querySelectorAll(".materia");
      materias.forEach(function (materia) {
        // Obtener el semestre de la materia
        var semestreMateria = materia.getAttribute("data-semestre");
        if (semestreMateria === semestreSeleccionado) {
          materia.style.display = "block";
        } else {
          materia.style.display = "none";
        }
      });
    }

    // Función para mostrar los grupos del semestre seleccionado
    function mostrarGruposPorSemestre(semestreSeleccionado) {
      // Obtener todos los botones de grupo
      var botonesGrupo = document.querySelectorAll(".grupo");
      botonesGrupo.forEach(function (botonGrupo) {
        botonGrupo.style.display = "none";
        // Mostrar solo los botones de grupo correspondientes al semestre seleccionado
        if (botonGrupo.getAttribute("data-semestre") === semestreSeleccionado) {
          botonGrupo.style.display = "block";
        }
      });
    }

    // Función para cambiar los valores de la tabla según el turno seleccionado
    function cambiarValoresTabla(turno) {
      const dias = document.querySelectorAll(".dia");
      const horas = document.querySelectorAll(".hora");

      if (turno === "N" || turno === "O") {
        dias.forEach(function (dia, index) {
          const id = parseInt(diasOriginales[index]) + 7;
          dia.id = id.toString();
        });
        horas.forEach(function (hora, index) {
          let inicio = 14 + index;
          let fin = 15 + index;
          if (fin > 22) {
            fin = 22;
          }
          hora.textContent = inicio.toString().padStart(2, '0') + '-' + fin.toString().padStart(2, '0');
        });
      } else {
        dias.forEach(function (dia, index) {
          dia.id = diasOriginales[index];
        });
        // Restaurar las horas en la tabla
        horas.forEach(function (hora, index) {
          hora.textContent = horasOriginales[index];
        });
      }
    }

    // Función para obtener la disponibilidad del docente y actualizar los colores de la tabla
    function actualizarDisponibilidadDocente(idDocente) {
      obtenerDisponibilidadDocente(idDocente, function (error, disponibilidad) {
        if (error) {
          console.error('Error:', error);
          alert('Error al obtener la disponibilidad del docente');
        } else {
          actualizarColoresTablaPorDisponibilidad(disponibilidad);
        }
      });
    }

    // Función para obtener la disponibilidad del docente desde el servidor
    function obtenerDisponibilidadDocente(idDocente, callback) {
      fetch(`/getDisponibilidad/${idDocente}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            callback(null, data.disponibilidad);
          } else {
            callback(new Error(data.message));
          }
        })
        .catch(error => {
          callback(error);
        });
    }

    function actualizarColoresTablaPorDisponibilidad(disponibilidad) {
    // Obtener todos los elementos .dia de la tabla
    const dias = document.querySelectorAll(".dia");
    // Iterar sobre los elementos .dia y actualizar el color según la disponibilidad del docente
    dias.forEach(dia => {
      // Verificar si la celda está vacía
      if (dia.textContent.trim() === "") {
        // Obtener el índice del día desde el ID del elemento .dia
        const index = parseInt(dia.id);
        // Verificar si la disponibilidad del docente en el día correspondiente es 1
        if (disponibilidad.disponibilidad[index] === 1) {
          dia.style.backgroundColor = "#2EDC41"; // Verde
        } else if (disponibilidad.disponibilidad[index] === 3) {
          dia.style.backgroundColor = "#D1CBCB"; // gris
        }
        else {
          dia.style.backgroundColor = "#FF6E33"; // Rojo
        }
      }
    });
  }

    function seleccionarsemestre() {
      var primerSemestre = document.querySelector(".semestre");
      if (primerSemestre) {
        primerSemestre.click();
      }
    }

    var botonesSemestre = document.querySelectorAll(".semestre");
    botonesSemestre.forEach(function (botonSemestre) {
      botonSemestre.addEventListener("click", function () {
        botonesSemestre.forEach(function (boton) {
          boton.classList.remove("selected");
        });// Remover la clase "selected" de todos los botones de turno
        var botonesTurno = document.querySelectorAll(".turno");
        botonesTurno.forEach(function (botonTurno) {
          botonTurno.classList.remove("selected");
        });
        this.classList.add("selected");
        var semestreSeleccionado = this.getAttribute("data-semestre");
        // Mostrar las materias del semestre seleccionado
        mostrarMateriasPorSemestre(semestreSeleccionado);
        // Mostrar los grupos del semestre seleccionado
        mostrarGruposPorSemestre(semestreSeleccionado);
        // Obtener el turno seleccionado 
        var primerTurno = document.querySelector(".turno");
        var turnoSeleccionado = primerTurno.getAttribute("data-turno");
        // Cambiar los valores de la tabla según el turno seleccionado
        cambiarValoresTabla(turnoSeleccionado);
      });
    });

    var botonesTurno = document.querySelectorAll(".turno");
    botonesTurno.forEach(function (botonTurno) {
      botonTurno.addEventListener("click", function () {
        botonesTurno.forEach(function (boton) {
          boton.classList.remove("selected");
        });
        this.classList.add("selected");

        // Obtener el turno seleccionado
        var turnoSeleccionado = this.getAttribute("data-turno");

        cambiarValoresTabla(turnoSeleccionado);
      });
    });

    // Agregar evento de clic para los botones de docente
    document.querySelectorAll('.docente').forEach(function (button) {
      button.addEventListener('click', function () {
        // Restaurar los colores originales de fondo de las celdas .dia
        document.querySelectorAll(".dia").forEach(cell => {
          cell.style.backgroundColor = "";
        });
        // Obtener el ID del docente
        const idDocente = this.getAttribute('data-id-docente');
        // Actualizar la disponibilidad del docente y los colores de la tabla
        actualizarDisponibilidadDocente(idDocente);
      });
    });

    seleccionarsemestre(); // Seleccionar automáticamente el primer semestre al cargar la página
  });

</script>

{% endblock %}