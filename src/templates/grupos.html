{% extends 'layout.html' %}

{% block title %}Grupos{% endblock %}

{% block css %}


<style>
html{
    font-family: Montserrat,Arial;
}
body{
    font-family: Montserrat,Arial;
}
    .btns {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0.5rem;
    }

    .btns .semestre {
        width: 100px;
        height: 30px;
        margin-left: 10px;
        border: none;
        margin-right: 10px;
        border-radius: 15px;
        transition: .5s;
    }

    .btns .semestre:hover {
        background-color: #37109b;
        color: white;
    }

    .semestre.selected {
        background-color: blue;
        border: #32aa32 2px solid;
        color: white;
    }

    .btnsturn {
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: Montserrat;
    }

    .btnsturn .turno:hover {
        background-color: #37109b;
        border: none;
        color: white;
    }

    .btnsturn .turno {
        width: 100px;
        border: none;
        height: 30px;
        margin-left: 10px;
        margin-right: 10px;
        border-radius: 15px;
        transition: .5s;
    }

    .btnsturn .turno.selected {
        background-color: #37109b;
        color: white;
        border: #32aa32 2px solid;
    }

    .container {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 0px 0px;
        grid-template-areas:
            ". . . ."
            "horario horario horario horario"
            "horario horario horario horario"
            "horario horario horario horario"
            ". . . .";
    }

    table {
        user-select: none;
        width: 156%;
        height: 98%;
        margin: auto;
        margin-top: 20px;
        border-collapse: collapse;
    }


    table tr {
        background-color: white;
        border: none;
    }

    table th,
    table td {
        border: 1px solid black;
        /* Añade bordes a las celdas */
        padding: 10px;
        /* Ajusta el espacio interno de las celdas */
    }

    table th {
        background-color: #ddd;
        /* Color de fondo para las celdas de encabezado */
    }

    table td {
        white-space: normal;
        font-size: 15px;
    }
</style>

{% endblock %}

{% block body_class %}grupos{% endblock %}



{% block content %}


<div class="btns">
    <button class="semestre" data-semestre="1">Semestre 1</button>
    <button class="semestre" data-semestre="2">Semestre 2</button>
    <button class="semestre" data-semestre="3">Semestre 3</button>
    <button class="semestre" data-semestre="4">Semestre 4</button>
    <button class="semestre" data-semestre="5">Semestre 5</button>
    <button class="semestre" data-semestre="6">Semestre 6</button>
    <button class="semestre" data-semestre="7">Semestre 7</button>
    <button class="semestre" data-semestre="8">Semestre 8</button>
    <button class="semestre" data-semestre="9">Semestre 9</button>
</div>
<div class="btnsturn">
    <p>Grupo :</p>
    <button class="turno" id="turnA">A</button>
    <button class="turno" id="turnB">B</button>
    <button class="turno" id="turnN">N</button>
</div>
<div class="container">
    <div class="horario"></div>
    <table id="TablaHorario">
        <tr>
            <th>Horas</th>
            <th>Lunes</th>
            <th>Martes</th>
            <th>Miercoles</th>
            <th>Jueves</th>
            <th>Viernes</th>
            <th>Sábado</th>
        </tr>
        <tr>
            <td class="hora hora-1">7-8</td>
            <td class="dia" id="0"></td>
            <td class="dia" id="15"></td>
            <td class="dia" id="30"></td>
            <td class="dia" id="45"></td>
            <td class="dia" id="60"></td>
            <td class="dia" id="75"></td>
        </tr>
        <tr>
            <td class="hora hora-2">8-9</td>
            <td class="dia" id="1"></td>
            <td class="dia" id="16"></td>
            <td class="dia" id="31"></td>
            <td class="dia" id="46"></td>
            <td class="dia" id="61"></td>
            <td class="dia" id="76"></td>
        </tr>
        <tr>
            <td class="hora hora-3">9-10</td>
            <td class="dia" id="2"></td>
            <td class="dia" id="17"></td>
            <td class="dia" id="32"></td>
            <td class="dia" id="47"></td>
            <td class="dia" id="62"></td>
            <td class="dia" id="77"></td>
        </tr>
        <tr>
            <td class="hora hora-4">10-11</td>
            <td class="dia" id="3"></td>
            <td class="dia" id="18"></td>
            <td class="dia" id="33"></td>
            <td class="dia" id="48"></td>
            <td class="dia" id="63"></td>
            <td class="dia" id="78"></td>
        </tr>
        <tr>
            <td class="hora hora-5">11-12</td>
            <td class="dia" id="4"></td>
            <td class="dia" id="19"></td>
            <td class="dia" id="34"></td>
            <td class="dia" id="49"></td>
            <td class="dia" id="64"></td>
            <td class="dia" id="79"></td>
        </tr>
        <tr>
            <td class="hora hora-6">12-13</td>
            <td class="dia" id="5"></td>
            <td class="dia" id="20"></td>
            <td class="dia" id="35"></td>
            <td class="dia" id="50"></td>
            <td class="dia" id="65"></td>
            <td class="dia" id="80"></td>
        </tr>
        <tr>
            <td class="hora hora-7">13-14</td>
            <td class="dia" id="6"></td>
            <td class="dia" id="21"></td>
            <td class="dia" id="36"></td>
            <td class="dia" id="51"></td>
            <td class="dia" id="66"></td>
            <td class="dia" id="81"></td>
        </tr>
        <tr>
            <td class="hora hora-8">14-15</td>
            <td class="dia" id="7"></td>
            <td class="dia" id="22"></td>
            <td class="dia" id="37"></td>
            <td class="dia" id="52"></td>
            <td class="dia" id="67"></td>
            <td class="dia" id="82"></td>
        </tr>
    </table>

    <div hidden style="overflow: hidden;">
        {% for docente in docentes %}
        <div class="docente" data-id-docente='{{docente.id}}' data-nombre="{{ docente.nombre }}"
            data-apellido="{{ docente.apellido_pat }}" hidden>
        </div>
        {% endfor %}
        {% for asignatura in asignaturas %}
        <div class="materia" data-semestre="{{ asignatura.semestre }}" data-id-materia='{{asignatura.id}}'
            data-credito="{{asignatura.creditos}}" data-nombre="{{ asignatura.nombre }}" hidden>
        </div>
        {% endfor %}
        {% for aula in aulas %}
        <div class="aula" data-id-aula="{{aula.id}}" data-nombre="{{ aula.nombre }}" hidden>
        </div>
        {% endfor %}
    </div>
</div>

<script>

    let diasOriginales = obtenerDiasOriginales();

    const horasOriginales = obtenerHorasOriginales();
    const turnA = document.getElementById("turnA");
    const turnB = document.getElementById("turnB");
    const turnN = document.getElementById("turnN");

    turnA.classList.add('selected');

    turnA.addEventListener("click", function () {
        restaurarHorasOriginales();
        cambiarTurno("A");
    });

    turnB.addEventListener("click", function () {
        restaurarHorasOriginales();
        cambiarTurno("B");
    });

    turnN.addEventListener("click", function () {
        cambiarTurno("N");
    });

    function cambiarTurno(turno) {
        document.querySelectorAll(".turno").forEach(btn => btn.classList.remove('selected'));
        document.getElementById(`turn${turno}`).classList.add('selected');
        const dias = document.querySelectorAll(".dia");
        if (turno === "N") {
            dias.forEach(function (dia, index) {
                const id = parseInt(diasOriginales[index]) + 7;
                dia.id = id.toString(); // Actualizar el ID del día
            });
            const horas = document.querySelectorAll(".hora");
            horas.forEach(function (hora, index) {
                let inicio = 14 + index;
                let fin = 15 + index;
                if (fin > 22) {
                    fin = 22;
                }
                hora.textContent = inicio.toString().padStart(2, '0') + '-' + fin.toString().padStart(2, '0');
            });
        } else {
            // Restaurar los IDs originales
            dias.forEach(function (dia, index) {
                dia.id = diasOriginales[index]; // Restaurar el ID del día
            });
        }
    }

    function obtenerDiasOriginales() {
        const diasOriginales = [];
        const dias = document.querySelectorAll(".dia");
        dias.forEach(function (dia) {
            diasOriginales.push(dia.id);
        });
        return diasOriginales;
    }

    function obtenerHorasOriginales() {
        const horasOriginales = [];
        const horas = document.querySelectorAll(".hora");
        horas.forEach(function (hora) {
            horasOriginales.push(hora.textContent);
        });
        return horasOriginales;
    }

    function restaurarHorasOriginales() {
        const horas = document.querySelectorAll(".hora");
        horas.forEach(function (hora, index) {
            hora.textContent = horasOriginales[index];
        });
    }
    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        let h = hash % 360; // Asegúrate de que el matiz esté en el rango [0, 360)
        let s = 60 + ((hash * 2) % 40); // Saturación variable entre 60% y 100%
        let l = 40 + ((hash * 4) % 30); // Luminosidad variable entre 40% y 70%

        return `hsl(${h}, ${s}%, ${l}%)`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.semestre').forEach(function (button) {
            button.addEventListener('click', function () {
                // Elimina la clase 'selected' de todos los botones de semestre
                document.querySelectorAll('.semestre').forEach(function (btn) {
                    btn.classList.remove('selected');
                });

                // Agrega la clase 'selected' al botón de semestre seleccionado
                this.classList.add('selected');

                var semestre = this.getAttribute('data-semestre');

                // Restaurar los colores originales de fondo de las celdas .dia
                document.querySelectorAll(".dia").forEach(cell => {
                    cell.textContent = "";
                    cell.style.backgroundColor = "";
                });

                getselecteditems(); // Llama a esta función para obtener los elementos seleccionados
            });
        });
    });

    // Simula un clic en el botón del semestre 1 al cargar la página
    document.addEventListener('DOMContentLoaded', function () {
        // Obtiene el botón del semestre 1
        const semestre1Btn = document.querySelector('.semestre[data-semestre="1"]');
        // Si el botón del semestre 1 existe, simula un clic en él
        if (semestre1Btn) {
            semestre1Btn.click();
        }
    });
    document.querySelectorAll('.turno').forEach(function (button) {
        button.addEventListener('click', function () {
            // Restaurar los colores originales de fondo de las celdas .dia
            document.querySelectorAll(".dia").forEach(cell => {
                cell.textContent = "";
                cell.style.backgroundColor = ""; // Restaurar el color de fondo
            });
            getselecteditems();
        });
    });

    function getselecteditems() {
        const semestreSeleccionadoElemento = document.querySelector('.semestre.selected');
        const semestreSeleccionado = semestreSeleccionadoElemento ? semestreSeleccionadoElemento.getAttribute('data-semestre') : '';
        const turnoSeleccionadoElemento = document.querySelector('.turno.selected');
        const turnoSeleccionado = turnoSeleccionadoElemento ? turnoSeleccionadoElemento.textContent.trim() : '';
        if (turnoSeleccionado && semestreSeleccionado) {
            gethorario(turnoSeleccionado, semestreSeleccionado);
        }
    }

    function gethorario(turno, semestre) {
        fetch(`/get_horario?turno=${turno}&semestre=${semestre}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener los datos de la base de datos');
                }
                return response.json();
            })
            .then(data => {
                if (!data.horario.docente || !data.horario.materia ||
                    !data.horario.aula || !data.horario.cell_ids) {
                    console.log("No se recibieron datos de docente, materia, aula o cellIds.");
                    return;
                }

                const docentes = data.horario.docente;
                const materias = data.horario.materia;
                const aulas = data.horario.aula;
                const cellIds = data.horario.cell_ids;

                // Limpiar las celdas antes de actualizar con nuevos datos
                document.querySelectorAll(".dia").forEach(cell => {
                    cell.textContent = "";
                    cell.style.backgroundColor = "";
                });

                cellIds.forEach((cellId, index) => {
                    const docenteId = docentes[index];
                    const materiaId = materias[index];
                    const aulaId = aulas[index];

                    const cell = document.getElementById(cellId);
                    if (cell) {
                        // Verificar si se recibieron valores para docente, materia y aula
                        if (docenteId && materiaId && aulaId) {
                            // Obtener los nombres directamente desde los atributos data-nombre
                            const docenteNombre = document.querySelector(`.docente[data-id-docente="${docenteId}"]`).dataset.nombre;
                            const docenteApellido = document.querySelector(`.docente[data-id-docente="${docenteId}"]`).dataset.apellido;
                            const nombreCompletoDocente = `${docenteNombre} ${docenteApellido}`;
                            const materiaNombre = document.querySelector(`.materia[data-id-materia="${materiaId}"]`).dataset.nombre;
                            const aulaNombre = document.querySelector(`.aula[data-id-aula="${aulaId}"]`).dataset.nombre;

                            // Crear elementos div para cada dato y agregarlos a la celda
                            const docenteDiv = document.createElement("div");
                            docenteDiv.textContent = `${nombreCompletoDocente}`;
                            docenteDiv.setAttribute('data-id', docenteId); // Agregar el atributo data-id


                            const materiaDiv = document.createElement("div");
                            materiaDiv.textContent = `${materiaNombre}`;
                            materiaDiv.setAttribute('data-id', materiaId); // Agregar el atributo data-id
                            materiaDiv.setAttribute('title', materiaDiv.textContent)


                            const aulaDiv = document.createElement("div");
                            aulaDiv.textContent = `${aulaNombre}`;
                            aulaDiv.setAttribute('data-id', aulaId); // Agregar el atributo data-id


                            cell.appendChild(docenteDiv);
                            cell.appendChild(materiaDiv);
                            cell.appendChild(aulaDiv);

                            // Opcional: asignar un color único basado en los IDs
                            cell.style.backgroundColor = stringToColor(`${docenteId}-${materiaId}-${aulaId}`);

                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error al obtener los datos de la base de datos:', error);
            });
    }
</script>
{% endblock %}